# Introduction
 [attendance]: https://github.com/fcharmy/face/tree/master/attendence 
 This Web Service uses Django and mySQL, provides public web page for users and private function for APIs.  
  
 There are mainly two major part of this web service, user interface and APIs. User interface let users create their own account, here we call a project, but it has the same functionality of user account. As [Attendance APP][attendance], it is a project which belongs to Face Tech, and each module is a group. In Face Tech web page, user can create a project, and then create many groups/persons under this project. So when they start building their project, they can use the APIs to call the functions.  
  
 When use APIs provided by Face Tech, all the data will be stored in server, including person profiles and the face images they use. Theoretically the more face images a person has, more accurate the result will be, but also if too many images, it will slow the computation.  
 
# Data Structure
 Data is stored in mySQL database, and use Models component of Django to retrive/update data from database, so you may check data via websiteURL/admin as well.

 [View Code](https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py)
 [Group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L8
 [Person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L26
 [Person_To_Group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L47
 [Face]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L52
 [get_real_name]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L62
 [add_or_get_person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L66
 [add_or_get_group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L82
 [auth_project_seckey]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L97
 [get_group_from_project]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L109
 [get_persons_from_project_by_ids]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L119
 [get_image_path]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/models.py#L135
  
## Tables
### [Group][Group]
 * name - unidque value which can only contain letters, numbers and .@+-]+, max length is 50
 * description - if optional then default is '', max length is 200
 * project - foreign key, User object from auth.models of Django
 * create_date - DateTimeField, auto generated by using creation time

 _**Method**_ to_dict:  
  return dictionary type of current group object
  
Each project can have many groups/persons, where project is exactly the same as User in Django.
    
### [Person][Person]
 * name - unidque value which can only contain letters, numbers and .@+-]+, max length is 50   
 * email - optional
 * first_name - optional, max length is 30  
 * last_name - optional, max length is 30  
 * note - optional, max length is 200  
 * project - foreign key, User object from auth.models of Django  
 * create_date - DateTimeField, auto generated by using creation time  
 _**Method**_ to_dict:  
  return dictionary type of current person object
  
  A person can belong to many groups or none, but it has to and only belongs to one project.
    
### [Person_To_Group][Person_To_Group]
 * group - foreign key, Group object
 * person - foreign key, Person object

This object will be delete when any foreign key does not exsits.

### [Face][Face]
 * person - foreign key, Person object
 * feature - feature array, obtain from feature extration algorithm and max_length is 10240
 * image - image path in server
 * create_date - DateTimeField, auto generated by using creation time  
 
One person may has many faces, but one face only belongs to one person, and each face will be used during verification.

## Private Functions
#### [get_real_name][get_real_name]
 * input: name (string), project (object)
 * output: real name for group (string)

when create a new group/person by project, combine project id with group/person name to be the name which store in database. This will guarantee if a group/person name is unique within a project, it will be unique in whole database.
 
#### [add_or_get_person][add_or_get_person]
 * input: name (string), project (object), email (defalt=''), first_name (defalt=''), last_name (defalt=''), note (defalt='')
 * output: person object or None if fail

create a new person, if exist, retrive the person object and return. If not exist, add into database and return the new person.
 
#### [add_or_get_group][add_or_get_group]
 * input: name (string), project (object), description (defalt='')
 * output: group object or None if fail

create a new group, if exist, retrive the group object and return. If not exist, add into database and return the new group.
 
#### [auth_project_seckey][auth_project_seckey]
 * input: id (integer), key (string)
 * output: project object or False if failV

given a pair of project id and security key, authenticate whether it is matched.

#### [get_group_from_project][get_group_from_project]
 * input: group_id (integer), project (object)
 * output: group object or None if fail

retrive group from a project, return group object if exist, otherwise return None.

#### [get_persons_from_project_by_ids][get_persons_from_project_by_ids]
 * input: person_id (integer or array), project (object)
 * output: person object or array of person objects, None if fail

given person id(s) to retrive person(s) from project and return.


#### [get_image_path][get_image_path]
 * input: person (object)
 * output: unique image path in server

when save a face, generate a unique image path in server.

# Web Pages
 Face Tech has a user interface for users, here they can create a project. Most of these user interface pages are [forms][forms], through these forms user may submit the action like add/update/delete. Many pages also have the same version of APIs, like create a group, user may use user interface or call API to do this, for this kind of function we will be cover in APIs.

 [View Code](https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py)
 [forms]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/forms.py
 [index]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L9
 [get start]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L17
 [create a project]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L30
 [project form]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/forms.py#L18
 [create project function]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L13
 [get_securitykey]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L408
 [login project]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L36
 [login form]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/forms.py#L26
 [authentication]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L37
 [project info]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L50
 [change password]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L43
 [change password function]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L67
 [create a group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L54
 [create a person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/views.py#L66

 * #### [Home Page][index]  
  
 * #### [Get Start Page][get start]  
  
 * #### [Create a project][create a project]  
  Use [project form][project form], then submit to [create_project][create project function] function. This will call [get_securitykey][get_securitykey] function to generate a unique security key for current project.  
  
 * #### [Login project][login project]  
  Use [login form][login form], then submit to [authentication][authentication] function.  
  
 * #### [Project Info][project info]
  
 * #### [Change password][change password]  
  Use Django PasswordChangeForm then submit to [change password function][change password function].  
  
 * #### [Create a group][create a group]  
  
 * #### [Create a person][create a person]  
 
# APIs

## Operation Component

 When user a project account, they may use [python wrapper][python] according to [user guide][user guide] to call all available APIs. APIs are all follow the format of [forms][forms], instead of using user interface, the request will be directly submit to resquest to the destination. All the API functions can accept cross site request so that they can be called in other domain, and every request need to submit with project id and security key due to security issue.  
  
 The following is the brief infomation about each API functions which is the destination of API request, but the real URL of each request should submit to, please according to the [mapping][mapping] relation. For example,  
 > url(r'^create_group', operate.create_group, name='create_group')  
 
The first part is the URL, the full path should be websiteURL/create_group. Then the second part is the function will be called when request submit to this URL, 'operate' is the python file where define create_group function, last part is a alias for convenience when use this in other functions.
 
 [user guide]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/templates/mkdocs/docs/getstart.md
 [python]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/static/face_tech.py
 [mapping]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/urls.py
 [create group function]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L81
 [group form]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/forms.py#L31
 [get_groups_by_name]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L102
 [create_person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L130
 [create_json_person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L174
 [relate_person_to_group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L221
 [get_persons_by_group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L253
 [get_all_persons]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L284
 [delete_person]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L309
 [delete_group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L338
 [delete_person_from_group]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/operate.py#L362
 
 * #### [create_group][create a group]  
  Params follow the format of [group form][group form].  
  
 * #### [get_groups_by_name][get_groups_by_name]  
  Given a name, retrive all the groups which contain the name.  
  
 * #### [create_person][create_person]  
  Given person profile to create a peron, user may submit many persons and seperate them with ';', but we do not recommend to do this, please use create_json_person instead.  
  
 * #### [create_json_person][create_json_person]  
  Given a json format object which contain all required information to create person(s).  
  
 * #### [relate_person_to_group][relate_person_to_group]  
  Assign person(s) to a group, one person may belongs to many group but only one project.  
  
 * #### [get_persons_by_group][get_persons_by_group]  
  Given a group id, retrive all the persons which belong to this group and order by person names.  
  
 * #### [get_all_persons][get_all_persons]  
  Given a project, retrive all persons which belong to this project (not recommend to use). 
  
 * #### [delete_person][delete_person]  
 
 * #### [delete_group][delete_group]  
 
 * #### [delete_person_from_group][delete_person_from_group]  
  Delete the relation between given person and group, which means this person is no longer belongs to given group, while person will not be deleted immediately but still belongs to current project.  
 

## Face Algorithm Component
 Face algorithm related functions have no user interface page, only provide for APIs and private functions which will be called by these API functions. API functions mainly return response to cross site request, and private functions will deal with data and implement face algorithm. As mentioned above, the real url for API request, please refer to the [mapping][mapping] relation, and all the request data send to API functions must contain project id and security key due to security issue.
 [View Code](https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py)
 [detect]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L11
 [landmark]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L41
 [occluder]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L68
 [check_quality]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L95
 [enrollment]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L134
 [verification]:  https://github.com/fcharmy/face/blob/master/face_web/face_tech/facial.py#L200
 [enroll_face]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L23
 [get_feature_array]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L50
 [verify_face_from_feature_array]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L71
 [detect_faces]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L98
 [detect_faces_cv2]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L119
 [detect_landmark]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L144
 [align_face]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L159
 [check_illumination]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L205
 [check_resolution]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L229
 [is_occluded]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L246
 [feature_extraction]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L251
 [compare]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L263
 [get_numpy_image]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/fac_pravite.py#L286
 
 * #### [Face Detection][detect]  
  Given a image of group or individual photo, detect all the face shown in the photo and return the coordinates of top, bottom, left and right corners of faces in json format.   
  There are two method of face detetion, one is [detect_faces_cv2][detect_faces_cv2] function based on opencv, the other is [detect_faces][detect_faces] function from dlib. Currently we use detect_faces inside face detetion API.
 
 * #### [landmark][landmark]  
  Given a image of group or individual photo, detect all the face shown in the photo, then detect 68 facial landmarks, return the face coordinates and landmarks coordinates in json format.
  
 * #### [occluder][occluder]  
 Given a image of group or individual photo, detect all the face shown in the photo, return True or False from [is_occluded][is_occluded] (not implement yet). 
 
 * #### [check_quality][check_quality]  
 Given a image of group or individual photo, detect all the face shown in the photo, return all the results from [check_illumination][check_illumination], [check_resolution][check_resolution] and [is_occluded][is_occluded] function in json format.
 
 * #### [enrollment][enrollment]  
 Given a image, face coordinates from face detection API and person ids whose these faces belong to, return the results from [enroll_face][enroll_face] function in json format. Before send face and id of each person to [enroll_face][enroll_face], we have to convert image to numpy array with [get_numpy_image][get_numpy_image], then align them with [align_face][align_face] function, at the end [enroll_face][enroll_face] will save the image of each person and feature which comes from [feature_extraction][feature_extraction] functioninto database.
 
 * #### [verification][verification]  
  Given a image of group or individual photo, detect all the face shown in the photo. For each face detected, retrive all persons features from database, [compare][compare] with the feature of current face, return result from [verify_face_from_feature_array][verify_face_from_feature_array] function.
 
# Python Wrapper
 We provide a python wrapper [face_tech.py][py] for Face Tech user to easily use APIs mentioned above, please refer to [getstart.md][guide] to learn more about how to use this. What's more, please remind that if any API updated or domain changed, modify this python wrapper as well.
 
 User may just download this file to their project, this python code can use APIs in Face Tech by just simply call function with the same name.
 
 [py]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/static/face_tech.py
 [guide]: https://github.com/fcharmy/face/blob/master/face_web/face_tech/templates/mkdocs/docs/getstart.md
 
# Implementation
 After upgrading, please refer to [IMPLEMENT.md](https://github.com/fcharmy/face/blob/master/face_web/IMPLEMENT.md) on how to implement new version.  
 To start server when reboot, make sure Nginx is working, then execute step 10 in [IMPLEMENT.md](https://github.com/fcharmy/face/blob/master/face_web/IMPLEMENT.md).
